{% extends "base.html" %}
{% block content %}

<div class="page">

  <!-- ========================= HEADER ========================= -->
  <header class="app-header">
    <div class="brand">
      <span class="logo-dot"></span>
      <span class="logo-text">Speech Studio</span>
    </div>

    <div class="header-right">
      <span class="pill">Speech · Docs · AI</span>
      <button type="button" id="themeToggle" class="theme-toggle">
        <span class="theme-icon"></span>
        <span class="theme-label" id="themeLabel">Dark</span>
      </button>
    </div>
  </header>

  <!-- ========================= SHELL (SIDEBAR + FORM) ========================= -->
  <div class="shell">

    <!-- ========================= SIDEBAR ========================= -->
    <aside class="sidebar glass-card glow-card">
      <div class="sidebar-header">
        <h3>Session docs</h3>
        <span class="sidebar-count">
          <span id="sideDocCount">0</span> / 5
        </span>
      </div>

      <ul id="sideDocList" class="side-doc-list">
        {% if doc_filenames %}
          {% for f in doc_filenames %}
            <li class="side-doc-item static">
              <div class="side-doc-main">
                <span class="dot"></span>
                <span class="side-doc-name">{{ f }}</span>
              </div>

              <button class="side-doc-remove"
                      data-type="server"
                      data-index="{{ loop.index0 }}">×</button>
            </li>
          {% endfor %}
        {% endif %}
      </ul>

      <button type="button" id="addSideDocs" class="btn ghost full small-top">
        Add / replace docs
      </button>

    </aside>

    <!-- ========================= MAIN FORM ========================= -->
    <form id="mainForm"
          method="post"
          enctype="multipart/form-data"
          class="layout glass-card glow-card slide-up">

      <input id="sideDocInput"
             type="file"
             name="session_docs"
             multiple
             accept=".pdf,.doc,.docx,.txt,.md"
             class="hidden-input">

      <!-- ========================= PROMPT PANEL ========================= -->
      <section class="card card-prompt">
        <div class="card-header-row">
          <h2>Prompt</h2>
          <span class="chip tiny">Step 1</span>
        </div>

        <p class="muted">Type or speak what you want the model to do.</p>

        <textarea id="promptText"
                  name="prompt_text"
                  class="input prompt-input"
                  rows="4"
                  placeholder="Example: Summarize the call or continue the speech…"></textarea>

        <div class="row spaced">
          <button type="button" id="promptMicBtn" class="chip">
            <span class="chip-icon mic-icon"></span>
            <span>Speak prompt</span>
          </button>
          <small id="promptMicStatus" class="hint">Click to record prompt audio.</small>
        </div>

        <input type="hidden" name="prompt_audio" id="promptAudioField">
      </section>


      <!-- ========================= AUDIO INPUT PANEL ========================= -->
      <section class="card card-io">
        <div class="card-header-row">
          <h2>Inputs</h2>
          <span class="chip tiny accent">Step 2</span>
        </div>

        <p class="muted">Upload audio or record live.</p>

        <label class="field">
          <span>Upload audio file</span>
          <input type="file" name="audio_file" accept="audio/*">
        </label>

        <div class="live-wrapper">
          <button type="button" id="liveMicBtn" class="live-mic">
            <span class="live-ring"></span>
            <span class="live-glyph"></span>
          </button>

          <div class="live-copy">
            <span class="live-title">Live capture</span>
            <span id="liveStatus" class="hint">Tap to start recording.</span>
          </div>
        </div>

        <div class="field">
          <span>Output type</span>
          <div class="options">
            <label><input type="radio" name="output_type" value="asr" checked> ASR</label>
            <label><input type="radio" name="output_type" value="classification"> Classification</label>
            <label><input type="radio" name="output_type" value="generation"> Generation</label>
          </div>
        </div>

        <input type="hidden" name="live_filename" id="liveAudioField">

        <button type="submit" class="btn primary full" id="runBtn">
          <span class="btn-label">Run Pipeline</span>
          <span class="btn-spinner"></span>
        </button>
      </section>

    </form>
  </div>

  <!-- ======================================================
        CARD 1 — SPEECHBRAIN RESULT (Glassmorphism)
       ====================================================== -->
  {% if sb_result %}
  <section class="card result-card glass-card glow-card fade-in">

    <h2 class="card-title">SpeechBrain Analysis</h2>

    <div class="result-body">
      <div class="result-text">

        <p><b>ASR Output:</b> {{ sb_result.sb_asr_text }}</p>

        <ul class="bullet-list">
          <li><b>Emotion:</b> {{ sb_result.sb_emotion }}</li>
          <li><b>Intent:</b> {{ sb_result.sb_intent }}</li>
          <li><b>Category:</b> {{ sb_result.sb_category }}</li>
        </ul>

      </div>

      <div class="result-side">
        <p class="result-title">Generated Audio</p>

        {% if sb_result.sb_audio_file %}
          <audio controls>
            <source src="{{ url_for('media_sb', filename=sb_result.sb_audio_file) }}">
          </audio>

          <a class="btn ghost small" target="_blank"
             href="{{ url_for('media_sb', filename=sb_result.sb_audio_file) }}">
            Download audio
          </a>
        {% else %}
          <p class="muted">No audio generated.</p>
        {% endif %}
      </div>
    </div>

  </section>
  {% endif %}


  <!-- ======================================================
        CARD 2 — WHISPER + MISTRAL RESULT (Glassmorphism)
       ====================================================== -->
  {% if whisper_result %}
  <section class="card result-card glass-card glow-card fade-in">

    <h2 class="card-title">Mistral Output</h2>

    <div class="result-body">
      <div class="result-text">

        <p><b>Whisper ASR:</b> {{ whisper_result.whisper_asr }}</p>

        <ul class="bullet-list">
          <li>{{ whisper_result.whisper_output }}</li>
        </ul>

      </div>

      <div class="result-side">
        <p class="result-title">Generated Audio</p>

        {% if whisper_result.whisper_audio_file %}
          <audio controls>
            <source src="{{ url_for('media_whisper', filename=whisper_result.whisper_audio_file) }}">
          </audio>

          <a class="btn ghost small" target="_blank"
             href="{{ url_for('media_whisper', filename=whisper_result.whisper_audio_file) }}">
            Download audio
          </a>
        {% else %}
          <p class="muted">No audio generated.</p>
        {% endif %}
      </div>
    </div>

  </section>
  {% endif %}

</div>

{% endblock %}
