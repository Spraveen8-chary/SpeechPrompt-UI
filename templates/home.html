{% extends "base.html" %}
{% block content %}
<div class="page">

  <header class="app-header">
    <div class="brand">
      <span class="logo-dot"></span>
      <span class="logo-text">Speech Studio</span>
    </div>

    <div class="header-right">
      <span class="pill">Speech · Docs · AI</span>
      <button type="button" id="themeToggle" class="theme-toggle">
        <span class="theme-icon"></span>
        <span class="theme-label" id="themeLabel">Dark</span>
      </button>
    </div>
  </header>

  <div class="shell">

    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <h3>Session docs</h3>
        <span class="sidebar-count">
          <span id="sideDocCount">0</span> / 5
        </span>
      </div>

      <ul id="sideDocList" class="side-doc-list">
        {% if doc_filenames %}
          {% for f in doc_filenames %}
            <li class="side-doc-item static">
              <div class="side-doc-main">
                <span class="dot"></span>
                <span class="side-doc-name">{{ f }}</span>
              </div>

              <!-- REQUIRED REMOVE BUTTON (linked to JS + Flask session) -->
              <button class="side-doc-remove"
                      data-type="server"
                      data-index="{{ loop.index0 }}">×</button>
            </li>
          {% endfor %}
        {% endif %}
      </ul>

      <button type="button" id="addSideDocs" class="btn ghost full small-top">
        Add / replace docs
      </button>

    </aside>


    <!-- Main Form (file input MUST be inside the form) -->
    <form id="mainForm"
          method="post"
          enctype="multipart/form-data"
          class="layout">

      <!-- ⚠️ Moved inside form (THIS FIXES YOUR ENTIRE APP) -->
      <input id="sideDocInput"
             type="file"
             name="session_docs"
             multiple
             accept=".pdf,.doc,.docx,.txt,.md"
             class="hidden-input">



      <!-- Prompt panel -->
      <section class="card card-prompt">
        <div class="card-header-row">
          <h2>Prompt</h2>
          <span class="chip tiny">Step 1</span>
        </div>

        <p class="muted">
          Type or speak what you want the model to do with your audio and documents.
        </p>

        <textarea id="promptText"
                  name="prompt_text"
                  class="input prompt-input"
                  rows="4"
                  placeholder="Example: summarize the call, extract action items..."
                  required></textarea>

        <div class="row spaced">
          <button type="button" id="promptMicBtn" class="chip">
            <span class="chip-icon mic-icon"></span>
            <span>Speak prompt</span>
          </button>
          <small id="promptMicStatus" class="hint">
            Click to record prompt audio.
          </small>
        </div>

        <input type="hidden" name="prompt_audio" id="promptAudioField">
      </section>



      <!-- Input panel -->
      <section class="card card-io">
        <div class="card-header-row">
          <h2>Inputs</h2>
          <span class="chip tiny accent">Step 2</span>
        </div>

        <p class="muted">
          Upload audio or record live. Documents are managed from the sidebar.
        </p>

        <label class="field">
          <span>Upload audio file</span>
          <input type="file" name="audio_file" accept="audio/*">
        </label>

        <div class="live-wrapper">
          <button type="button" id="liveMicBtn" class="live-mic">
            <span class="live-ring"></span>
            <span class="live-glyph"></span>
          </button>

          <div class="live-copy">
            <span class="live-title">Live capture</span>
            <span id="liveStatus" class="hint">Tap to start recording.</span>
          </div>
        </div>

        <div class="field">
          <span>Output type</span>
          <div class="options">
            <label><input type="radio" name="output_type" value="asr" checked> ASR</label>
            <label><input type="radio" name="output_type" value="classification"> Classification</label>
            <label><input type="radio" name="output_type" value="generation"> Generation</label>
          </div>
        </div>

        <input type="hidden" name="live_filename" id="liveAudioField">

        <button type="submit" class="btn primary full" id="runBtn">
          <span class="btn-label">Run pipeline</span>
          <span class="btn-spinner"></span>
        </button>
      </section>

    </form>

  </div>


  <!-- Result panel -->
  <section class="card result-card {% if result_text or audio_filename or doc_filenames %}active{% endif %}">
    <div class="result-header">
      <span>Result</span>
      <span class="dot-indicator" id="resultIndicator"></span>
    </div>

    <div class="result-body">
      <div class="result-text">
        {{ result_text | safe or "Results will appear here once the pipeline finishes." }}
      </div>

      <div class="result-side">

        <!-- Audio result -->
        <div class="result-audio">
          {% if audio_filename %}
            <p class="result-title">Audio</p>

            <audio controls>
              <source src="{{ url_for('media', filename=audio_filename) }}"
                      type="audio/webm">
            </audio>

            <a class="btn ghost small"
               href="{{ url_for('media', filename=audio_filename) }}">
              Download audio
            </a>
          {% else %}
            <p class="muted">No audio output yet.</p>
          {% endif %}
        </div>


        <!-- Document result -->
        <div class="result-docs">
          <p class="result-title">Documents</p>

          {% if doc_filenames %}
            <ul class="doc-list">
              {% for f in doc_filenames %}
                <li class="doc-pill">
                  <span class="dot"></span>
                  <span>{{ f }}</span>
                </li>
              {% endfor %}
            </ul>
          {% else %}
            <p class="muted">No documents uploaded in this run.</p>
          {% endif %}
        </div>

      </div>
    </div>
  </section>

</div>
{% endblock %}
